version: '3.7'
services:
  backend:
    build:
      context: ./backend
    container_name: chess_backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    networks:
      - chess-net

  web:
    # --- UPDATED BUILD: Use custom FrankenPHP Dockerfile ---
    build:
      context: .
      dockerfile: frontend/Dockerfile
    # ----------------------------------------------------
    container_name: chess_web
    restart: unless-stopped
    tty: true
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp" # For HTTP/3
    environment:
      # --- FIX: Removed the problematic CADDY_HOSTNAME default (localhost) ---
      # This line is kept for the Cloudflare API Token for DNS-01 challenge:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      # ---------------------------------------------------------------------
    volumes:
      - ./frontend:/app/public
      - ./Caddyfile.prod:/etc/frankenphp/Caddyfile
      # --- ADDED: Caddy data volumes for cert storage ---
      - caddy_data:/data
      - caddy_config:/config
      # --------------------------------------------------
    depends_on:
      - backend
    networks:
      - chess-net

networks:
  chess-net:
    driver: bridge

# --- ADDED: Volume definitions for Caddy ---
volumes:
  caddy_data:
  caddy_config:
# -------------------------------------------
