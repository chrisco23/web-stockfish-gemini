version: '3.8'

services:
  backend:
    build:
      context: ./backend
    container_name: chess_backend
    restart: unless-stopped
    # Use env_file to pass secrets (GOOGLE_API_KEY)
    env_file:
      - .env
    ports:
      - "8000:8000" # internal; Caddy will talk to this
    volumes:
      - ./backend:/app
    networks:
      - chess-net

  web:
    image: dunglas/frankenphp:latest # Use the standard image
    container_name: chess_web
    restart: unless-stopped
    tty: true
    ports:
      # Expose standard HTTP/HTTPS ports
      - "80:80"
      - "443:443"
      - "443:443/udp" # For HTTP/3 (best practice)
    # Critical: Do NOT use CADDY_HOSTNAME. We define the domain in Caddyfile.prod.
    volumes:
      - ./frontend:/app/public
      # CRITICAL: Mount the production Caddyfile to the correct path
      - ./Caddyfile.prod:/etc/frankenphp/Caddyfile
      # Add persistent volumes for Caddy's certificates and configuration
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - backend
    networks:
      - chess-net

networks:
  chess-net:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
