# /home/fugbert/www/web-stockfish-gemini/docker-compose.yml.prod

services:
  backend:
    # ... (No changes here, remains the same)
    build:
      context: ./backend
    container_name: chess_backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    networks:
      - chess-net

  web:
    # --- START EDITS ---
    build:
      context: . # Build context is root to access the frontend/Dockerfile
      dockerfile: frontend/Dockerfile # Points to the new custom Caddy/PHP Dockerfile
    # --- END EDITS ---
    container_name: chess_web
    restart: unless-stopped
    tty: true
    ports:
      - "80:80"
      - "443:443"
    environment:
      - CADDY_HOSTNAME=${CADDY_HOSTNAME:-localhost}
      # --- CRITICAL ADDITION: CLOUDFLARE TOKEN ---
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      # -------------------------------------------
    volumes:
      # We rely on your existing volumes setup
      - ./frontend:/app/public
      - ./Caddyfile.prod:/etc/frankenphp/Caddyfile
      # Add volumes for Caddy to store its certificate data
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - backend
    networks:
      - chess-net

networks:
  chess-net:
    driver: bridge

# --- CRITICAL ADDITION: CADDY VOLUMES ---
volumes:
  caddy_data:
  caddy_config:
# ---------------------------------------
